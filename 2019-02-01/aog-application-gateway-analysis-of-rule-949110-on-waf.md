---
title: "WAF 规则 949110 分析"
description: "WAF 规则 949110 分析"
author: tiffanyguo721
resourceTags: 'WAF, Rule 949110'
ms.service: application-gateway
wacn.topic: aog
ms.topic: article
ms.author: lina.guo
ms.date: 02/13/2019
wacn.date: 02/13/2019
---

# WAF 规则 949110 分析

在使用 WAF 对应用程序网关进行安全防御时，用户可能会遇到一些规则阻挡了业务请求，但是却无法 disable 这些规则，例如规则 949110，规则 980130，这两个规则是强制性无法被 disable 的，下面截取两个规则匹配细则做参考：

```bash
"ruleId": "949110",
"message": "Mandatory rule. Cannot be disabled. Inbound Anomaly Score Exceeded (Total Score: 10)",
"ruleId": "980130",
"message": "Mandatory rule. Cannot be disabled. Inbound Anomaly Score Exceeded (Total Inbound Score: 10 - SQLI=5,XSS=5,RFI=0,LFI=0,RCE=0,PHPI=0,HTTP=0,SESS=0): SQL Injection Attack: SQL Tautology Detected."
```

WAF 中不同的规则对应不同的严重等级和积分贡献，积分贡献的总和决定是否触发 949110 这条规则。例如一个请求可能会匹配超过一条规则，如果这几条规则贡献的积分总和超过了 5 分，就会触发 949110 这条规则从而使请求被阻挡。而由于 949110 是无法被 disable 的，如果用户暂时无法调整应用层面的代码，且想尽快解决被阻挡的问题的话，建议 disable 掉其他同时触发的规则，避免积分达到阈值而触发规则 949100。

下表是不同规则的严重等级和积分贡献程度：

Severity|Level|Anomaly Score|Comment
-|-|-|-
|Critical|2|5|Is the highest severity level possible without correlation. It is normally generated by the web attack rules (40 level files). |
|Error|2|4|Is generated mostly from outbound leakage rules (50 level files).|
|Warning|4|3|Is generated by malicious client rules (35 level files).|
|Notice|5|2|Is generated by the Protocol policy and anomaly files.|

WAF 底层使用的是 ModSecurity 模块，会拒绝积分达到 5 或者更高分数的请求，Azure 的应用程序网关中 WAF 的设计也遵照了这一原则，且用户无法去更改这一行为，例如一条严重等级为 Critical 的规则的积分计算公式为：

 `setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}`，

如果一条请求只触发了一条 Warning 或者 Notice 等级的规则，该请求不会被 WAF 阻挡，因为积分没有达到 5 分。但如果同时触发了例如两条 Warning 类型的规则，积分贡献超过了 5 分后，就会被 WAF 中的 ModSecuity 模块拒绝。

对于用户遇到的一些常见的 WAF 规则匹配问题，建议可以开启应用程序网关的诊断后，下载 Firewall log，找到对应的时间点，并过滤相应的 Client IP，查找实际触发的规则以及触发的原因，再结合上述的积分规则进行分析。
